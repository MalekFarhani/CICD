pipeline{
    
    agent any

environment {
  DOCKER_TAG = getVersion()
}

stages{
    stage('pulling the code'){
        steps{
            git branch: 'main', 
            url: 'https://github.com/MalekFarhani/TestingJavaApp'
}}
    stage('build'){
        steps{ 
            sh 'mvn clean package'
}}
    stage('docker'){
        steps{ 
                sh 'docker build . -t testing:${DOCKER_TAG}'      //docker build -t my-app:latest .------ we will use the commit Id to tag our Dockerimage
                sh 'docker tag testing:${DOCKER_TAG} malekkkk/testing:${DOCKER_TAG}'    // docker tag my-app:latest your-username/my-app:latest
}}
   stage('docker login'){
        steps {
                withCredentials([string(credentialsId: 'dockerhub', variable: 'dockerpwd')]){      
                        sh 'docker login -u malekkkk -p ${dockerpwd}'
            }}}
   
    stage ('docker push'){
        steps{
            sh 'docker push malekkkk/malekrepo:testing'  //docker push malekkkk/malekrepo:tagname
        }
    }
}}
def getVersion()
{
   def commitHash = sh returnStdout: true, script: 'git rev-parse --short  HEAD'
   return commitHash 
}

